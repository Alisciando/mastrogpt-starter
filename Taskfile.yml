version: '3'

dotenv:
- .env

vars:
    DRY: ""
    SKIP: ""
    FLAGS: ""

tasks:
    default: task -l

    build:venv:
        requires: { vars: [A] }
        cmds:
        -   >
            bash util/build-venv.sh 
            $(pwd)/packages/{{.A}}/requirements.txt
            $(pwd)/packages/{{.A}}.zip
        sources:
        - "packages/{{.A}}/requirements.txt"
        generates:
        - "packages/{{.A}}.zip"

    build:venv:old:
        requires: { vars: [A] }
        cmds:
        - cp "packages/{{.A}}/requirements.txt" "util/requirements.txt"
        - bash util/virtualenv.sh
        - mv util/virtualenv.zip "packages/{{.A}}.zip"
        - task: build:action
        sources:
        - "packages/{{.A}}/requirements.txt"
        generates:
        - "packages/{{.A}}.zip"

    build:action:
        aliases: [b]
        requires: { vars: [A] }
        cmds:
        -   |
            FILE=$(basename "{{.A}}")
            cd packages/{{.A}}
            zip ../$FILE.zip  * -x requirements.txt
        sources:
        - packages/{{.A}}/*
        generates:
        - packages/{{.A}}.zip

    clean:
        ignore_error: true
        cmds:
        - rm -v packages/*/*.zip

    setup: 
        desc: setup Nuvolaris MastroGPT
        cmds:
        -   |
            nuv -version
            pip install --upgrade pip
            pip install watchdog
            for i in packages/*/*/requirements.txt
            do pip install -r $i
            done
            if ! test -e ~/.wskprops
            then task config
            fi

    cli: |
        ipython -i util/init.ipy
    
    serve:
        aliases: [s]
        cmds:
        - http-server -a 127.0.0.1 web -c-1 --mimetypes util/mime.types  -P $NUVDEV_HOST

    deploy:
        desc: deploy actions
        cmds:
        - python -m util.deploy {{.FLAGS}}

    undeploy:
        ignore_error: true
        desc: undeploy actions
        cmds:
        - task: clean
        - >
            nuv action list | awk 'NR>1 t{ print $1}' | xargs -L1 nuv action delete
 
    devel:
        desc: incrementa interactive development mode
        cmds:
        - python -m util.deploy -w {{.FLAGS}}
        
    config:
        desc: configure Nuvolaris MastroGPT
        silent: true
        cmds:
        -   |
            echo -n "Enter nuvolaris.dev Username: "
            read NUVDEV_USERNAME
            nuv -login https://nuvolaris.dev "$NUVDEV_USERNAME"
            if test -e ~/.wskprops
            then
                source ~/.wskprops
                echo "NUVDEV_USERNAME=$NUVDEV_USERNAME" >.env
                echo "NUVDEV_HOST=https://$NUVDEV_USERNAME.nuvolaris.dev" >>.env
                echo "OPENAI_API_HOST=https://openai.nuvolaris.io" >>.env
                echo "$AUTH" | awk -F: '{print "OPENAI_API_KEY=" $1 }' >>.env
            fi




